软件设计说明V1
2017年12月1日
一、命令字符串： 
控制命令是一个字符串，分为阻塞式和非阻塞式。阻塞式命令用“(”开头，“)”结束，多个命令用“;”分隔，一次只能控制一个对象，执行时必须保证其它阻塞命令已经执行完，命令完成后再按顺序执行下一个阻塞命令。非阻塞式用“[”开头，“]”结束，多个命令用“;”分隔，非阻塞执行，可以同时控制多个对象，所有命令同时发出，不等待执行结束立即返回。
一条命令字符串长度小于等于60个字节以回车换行结尾，一条命令字符串包含至少1条，最多8条命令。字符串中字母大小写均可。
命令字符串通过串口通讯任务接收，可以通过向串口发送测试命令验证各个模块
功能块	执行命令	查询状态	命令类型
写文件	Fd,文件名[,内容]	F（磁盘信息、文件列表）	非阻塞
日期	D0yymmdd（8字节）	D（1字节）	非阻塞
时间	N0hhmmss（8字节）	N（1字节）	非阻塞
温度	Tnnb（4字节）	T（1字节）	非阻塞
阀	Vnnb（4字节）	V（1字节）	非阻塞
步进电机	Snnkpppp（8字节）	S（1字节）	非阻塞；阻塞
蠕动泵	Pnnktttt（8字节）	P（1字节）	非阻塞；阻塞
旋转泵	Rnnctttt（8字节）	R（1字节）	非阻塞；阻塞
延时	Wxxxxxxx（8字节）	W（1字节）	阻塞
参数定义：
代号	含义	范围
d	读写删文件。系统初始化默认当前文件夹“0:/TEST”，默认当前文件名“0001”	0：读，读文件可以更新当前文件名；1：写，追加，保存；2：删除；3：设置当前文件夹。4：格式化磁盘。
yymmdd	年月日	[00~99]年，[01~12]月，[01~31]日， 
hhmmss	时分秒	[00~23]时，[00~59]分，[00~59]秒
nn	功能块编号	[01~99]
b	关闭或打开状态	[0,1]，0关闭；1打开
c	速度大小：低、中、高	[0,1,2]
pppp	位置或与液面距离	0nnn：位置；1nnn：进入液面并移动，2nnn：离开液面并移动，3nnn：转动时间(100ms)，4nnn：到原点距离(mm)。原点定义？
k	速度（低、中、高）和方向	[0,1,2]+ [0,4]，大于等于4代表反转
tttt	代表tttt*0.1秒	[0001~9999]
xxxxxxx	代表xxxxxxx *1毫秒	[0000001~9999999]
例如：[V021; S0310003]//开阀2，步进电机3中速运行到位置3；(P0130020; W0005000)//蠕动泵1低速反转2秒，延时5秒
文件操作：	[F0,A00010001U000000]，更新当前文件名，返回当前文件名，返回文件内容或空。打开标志为0才能修改当前文件名
[F0]，返回当前文件名，返回文件内容或空。打开标志为0才能修改当前文件名
[F1,ABCDEFG]，写文件，向 “当前文件夹/当前文件名”写入内容，长度大于0小于等于50，包括所有可以显示的ASCII码，结尾添加换行。对同一个文件写入为追加。设置一个打开标志，为0打开当前文件，并写2，避免重复打开当前文件。目的是为了减少频繁close次数。改写标志时标志必须为0
[F1]，写文件结束，保存并关闭当前文件。空文件？打开标志从2设为0
[F2]，删当前文件，打开标志为0才能删除 
[F3,0:/CRP]，创建并设置当前文件夹，必须是绝对路径。打开标志为0才能修改当前文件夹
[F3]，返回当前文件夹
[F4]，格式化磁盘。
[F]，显示磁盘，显示当前文件夹中的目录和文件以及下一层的目录和文件。
二、数据格式：
1.测试结果
在FLASH中创建CRP文件夹，每次测试结束后创建一个日期文件夹，如：2018-01-01，在日期文件夹下以文件形式保存当前数据，文件名为【序号+编号+结果】，如：A00010001U000000，序号开头字母可以是A,B,C代表不同的反应杯后面是4位数字，编号为4位数字，结果开头字母为U代表后面的6位数字是uL为单位的整数值。
文件内容：测试数据【以逗号分割，回车换行结束】；序号，编号【回车换行】；测试项目【回车换行】，日期时间【回车换行】。
三、任务：任务之间要传递信息，所有任务一次创建完成，每个任务有一个状态机，有定时复位机制
Main：硬件初始化，创建主任务start_task，启动调度器
主任务：(start_task) 创建其它任务以及软件定时器，消息队列，信号量，事件标志组，任务通知等，创建完成删除自己。

HMI界面UART通讯：(hmi_task)负责界面显示。发送命令给HMI界面，接收HMI界面消息，接收其它任务的消息，数据读取和显示，条形码读取

串口通讯：(com_task)接收控制命令，返回信息。接收串口消息，发送消息给串口

阀控制、步进电机控制、泵控制：(valve_task，step_task，pump_task)接收阀控制信息（开关），接收步进电机控制信息（速度，位置），接收泵控制信息（速度，方向，时间）；返回各硬件状态

CRP检测流程：(crp_task) 开机自检：从HMI读取当前时间赋值给RTC，步进电机运动，光电信号测试，阀，泵控制


RBC检测流程：(rbc_task)，三个比色皿状态机分配


AD采样123：(adc_task)三个比色皿可以同时进行，数据有效/无效，具体数据，数据存储


清洗比色皿123：(wash_cuvette_task) 三个比色皿只能一个一个清洗


维护：(maintain_task)

四、函数：进入和返回时，状态需要保持不变
清洗池：


温控：抗体液2~8°控制，比色皿25℃控制。


洗针：


灌注：


排空：

五、测试任务：
串口测试：

HMI测试：

速度测试：步进电机，旋转泵，蠕动泵

精度测试：步进电机
哪些步进电机可以复用？

开关测试：74HC59可靠性测试，二通阀，三通阀开关、对电路的冲击、电流负载能力

AD测试：

温控测试：抗体液2~8℃；比色皿25℃

条形码测试：

恒流测试：RBC恒流驱动

六、界面：
A.开机欢迎，请确认废液管路畅通，反应杯正确安装，试剂已正确连接；确认；再次确认；系统复位；洗针；采样针出来；打缓冲液到杯中。（运动控制）
B.测试，扫描条形码，读取1.试剂批号，2.检测项目，3.单位，4.剩余人份，5.样本类型，6.样本来源，7.正常值参考，8.ABCD；刷卡，读卡成功/失败，显示当前样本序号，编号，状态/结果（自动进样）；按测试键开始测试流程，实时显示状态，最终结果显示，实时显示三个反应杯的OD变化曲线。测试结束扣除一次剩余人份。发生故障（哪些故障？剩余人份不减？）立即停止。（根据配置情况，分配反应杯子，运动控制，读卡，AD采样。试剂批号，剩余人份，AD采样值，保存FALSH）（状态/结果：试剂已用完，自动进样，采样OD值；实时状态：已满，正常；读卡：读卡成功，读卡失败）（创建CRP目录，按日期创建文件夹存放测试结果）
C.查询，按编号，按时间，按结果查询数据，打印数据（姓名，项目，样本编号，测量结果，测量时间，当前时间）。点击测试结果显示曲线。
D.
