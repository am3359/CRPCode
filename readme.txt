软件设计说明
2017年12月1日
一、命令字符串： 
控制命令是一个字符串列表，分为阻塞式和非阻塞式。阻塞式命令用“(”开头，“)”结束，中间多个命令用“;”分隔，一次只能控制一个对象，执行时当前处于空闲状态，需要等到该命令完成再按顺序执行下一个命令。非阻塞式用“[”开头，“]”结束，可以控制多个对象，中间多个命令用“;”分隔，为非阻塞执行，所有命令同时发出，不等待执行结束立即返回。
一条命令字符串长度小于等于60个字节以回车换行结尾，一条命令字符串包含至少一条最多8条命令，否则无效。
命令字符串可以由HMI任务或串口通讯任务发送，串口发测试命令可以验证各个模块
功能块	执行命令	查询状态
阀	Vnnb（4字节）非阻塞式命令	V（1字节）
步进电机	Snncpppp（8字节）非阻塞式或阻塞命令	S（1字节）
蠕动泵	Pnnktttt（8字节）非阻塞式或阻塞命令	P（1字节）
旋转泵	Rnnctttt（8字节）非阻塞式或阻塞命令	R（1字节）
温度	Tnnb（4字节）非阻塞式命令	T（1字节）
延时	Wxxxxxxx（8字节）阻塞式命令	W（1字节）
日期	D0yymmdd（8字节）非阻塞式命令	D（1字节）
时间	N0hhmmss（8字节）非阻塞式命令	N（1字节）
参数定义：
代号	含义	范围
nn	功能块编号	[01~99]
b	关闭或打开状态	[0,1]，0关闭；1打开
c	速度大小：低、中、高	[0,1,2]
pppp	位置或与液面距离	0nnn：位置；1nnn：进入液面并移动，2nnn：离开液面并移动，3nnn：转动时间(100ms)，4nnn：到原点距离(mm)
k	速度（低、中、高）和方向	[0,1,2]+ [0,4]大于4代表反转
tttt	代表tttt*0.1秒	[0001~9999]
xxxxxxx	代表xxxxxxx *1毫秒	[0000001~9999999]
yymmdd	年月日	[00~99]年，[01~12]月，[01~31]日， 
hhmmss	时分秒	[00~23]时，[00~59]分，[00~59]秒
例如：[V021; S0310003]//开阀2，步进电机3中速运行到位置3；(P0130020; W0005000)//蠕动泵1低速反转2秒，延时5秒
二、任务：任务之间要传递信息，所有任务一次创建完成，每个任务有一个状态机，有定时复位机制
Main：硬件初始化，创建主任务start_task，启动调度器
主任务：(start_task) 创建其它任务以及软件定时器，消息队列，信号量，事件标志组，任务通知等，创建完成删除自己。
开机自检：步进电机运动，光电信号测试，阀，泵控制
HMI界面UART通讯：(hmi_task)负责界面显示。发送命令给HMI界面，接收HMI界面消息，接收其它任务的消息，数据读取和显示

串口通讯：(com_task)接收控制命令，返回信息。接收串口消息，发送消息给串口

阀控制、步进电机控制、泵控制：(valve_task，stepmoto_task，pump_task)接收阀控制信息（开关），接收步进电机控制信息（速度，位置），接收泵控制信息（速度，方向，时间）；返回各硬件状态

CRP检测流程：(crp_task)


RBC检测流程：(rbc_task)，三个比色皿状态机分配


AD采样123：(adc_task)三个比色皿可以同时进行，数据有效/无效，具体数据，数据存储



清洗比色皿123：(wash_cuvette_task) 三个比色皿只能一个一个清洗

维护：(maintain_task)

函数：进入和返回时，状态需要保持不变
清洗池：


温控：


洗针：


灌注：


排空：

测试任务：
串口测试：

HMI测试：

速度测试：步进电机，旋转泵，蠕动泵

精度测试：步进电机

开关测试：二通阀，三通阀

AD测试：

温控测试：抗体液2~8℃；比色皿25℃

条形码测试：

恒流测试：RBC恒流驱动

