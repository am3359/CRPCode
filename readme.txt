软件设计说明V1
2018年3月14日
一、串口命令： 
控制命令是一个字符串，分为阻塞式和非阻塞式。阻塞式命令用“(”开头，“)”结束，多个命令用“;”分隔，一次只能控制一个对象，执行时必须保证其它阻塞命令已经执行完，命令完成后再按顺序执行下一个阻塞命令。非阻塞式用“[”开头，“]”结束，多个命令用“;”分隔，非阻塞执行，可以同时控制多个对象，所有命令同时发出，不等待执行结束立即返回。
一条命令字符串长度小于等于60个字节以回车换行结尾，一条命令字符串包含至少1条，最多8条命令。字符串中字母大小写均可。
命令字符串通过串口通讯任务接收，可以通过向串口发送测试命令验证各个模块
功能块	执行命令	查询状态	命令类型
写文件	Fd,文件名[,内容]	F（磁盘信息、文件列表）	非阻塞
日期	D0yymmdd（8字节）	D（1字节）	非阻塞
时间	N0hhmmss（8字节）	N（1字节）	非阻塞
温度	Tnnb（4字节）	T（1字节）	非阻塞
阀	Vnnb（4字节）	M（1字节）	非阻塞；阻塞
步进电机	Snnkpppp（8字节）	M（1字节）	非阻塞；阻塞
蠕动泵	Pnnktttt（8字节）	M（1字节）	非阻塞；阻塞
旋转泵	Rnnb（4字节）	M（1字节）	非阻塞；阻塞
延时	Wxxxxxxx（8字节）	M（1字节）	阻塞
机械复位	A（1字节）	M（1字节）	阻塞
取消	C（1字节）	M（1字节）	非阻塞；阻塞
计算S曲线	Bccccddddaaaa（13字节）	B（1字节）	非阻塞
AD采样	Gnpppxxxxxx（11字节）	G（1字节）	非阻塞；阻塞
参数定义：
代号	含义	范围
d	读写删文件。系统初始化默认当前文件夹“0:/TEST”，默认当前文件名“0001”	0：读，读文件可以更新当前文件名；1：写，追加，保存；2：删除；3：设置当前文件夹。4：格式化磁盘。
yymmdd	年月日	[00~99]年，[01~12]月，[01~31]日， 
hhmmss	时分秒	[00~23]时，[00~59]分，[00~59]秒
nn	功能块编号	[01~99]
b	关闭或打开状态	[0,1]，0关闭；1打开
pppp	位置或与液面距离	0nnn：位置；1nnn：进入液面并移动，2nnn：离开液面并移动，3nnn：转动时间(100ms)，4nnn：到原点距离(mm)。原点定义？
k	速度（低、中、高）和方向	[0,1,2]+ [0,4]，大于等于4代表反转
tttt	代表tttt*100毫秒	[0001~9999]
xxxxxxx	代表xxxxxxx *1毫秒	[0000001~9999999]
ccccddddaaaa	cccc:C0，dddd:C0，aaaa代表a	用于计算S曲线
注：不论阻塞或非阻塞步进电机同一时刻只有一个可以动作，动作时其它命令都等待
Gnpppxxxxxx说明，n为AD编号(1,2,3)，ppp是采样数量(1~999)，xxxxxx是采样时间间隔(1~999999)ms。
例如：[V021; S0310003]//开阀2，步进电机3中速运行到位置3；(P0130020; W0005000)//蠕动泵1低速反转2秒，延时5秒
文件操作：	[F0,A00010001U000000]，更新当前文件名，返回当前文件名，返回文件内容或空。打开标志为0才能修改当前文件名
[F0]，返回当前文件名，返回文件内容或空。打开标志为0才能修改当前文件名
[F1,ABCDEFG]，写文件，向 “当前文件夹/当前文件名”写入内容，长度大于0小于等于50，包括所有可以显示的ASCII码，结尾添加换行。对同一个文件写入为追加。设置一个打开标志，为0打开当前文件，并写2，避免重复打开当前文件。目的是为了减少频繁close次数。改写标志时标志必须为0
[F1]，写文件结束，保存并关闭当前文件。空文件？打开标志从2设为0
[F2]，删当前文件，打开标志为0才能删除 
[F3,0:/CRP]，创建并设置当前文件夹，必须是绝对路径。打开标志为0才能修改当前文件夹
[F3]，返回当前文件夹
[F4]，格式化磁盘。
[F]，显示磁盘容量，显示当前文件夹向下8层的目录结构。
二、数据格式：
1.测试结果保存格式
测试项目-------固定为“超敏CRP”
单位-----------固定为“mg/L”
剩余人份----在更换R2时刷新，以后做样品时递减
测试结果保存内容和格式：
序号：(A:cnnnn\r\n) ---------自动生成，有一个文件存储序号，用于记录，长度小于等于8字节
编号：(B:nnnnnnnnnnnn\r\n) ---------自动生成、扫描条形码或手动输入，有一个文件存储序号，用于记录，长度小于等于16字节，从试管输入。
试剂批号：(C: nnnnnnnnnnnn \r\n) -----条形码输入，长度小于等于16字节，从抗体液卡片输入
用户名：(D:cccccccc\r\n )-------在设置里手动输入（如**医院），长度小于等于16字节？
单位：(E:mg/L\r\n) ---------固定为“mg/L”，长度小于等于8字节
样本类型：(F:全血\r\n )-----在设置里手动输入（如全血，血清），长度小于等于16字节
样本来源：(G:静脉血\r\n) -----在设置里手动输入（如静脉血，末梢血，预稀释血），长度小于等于16字节
正常值参考：(H:下限,上限\r\n) ---是叫参考值范围还是正常值参考？手动输入数字，是限值吗？，长度小于等于8字节
测量结束时间：(I:yymmddhhmm\r\n) -自动生成，长度小于等于16字节
数据个数：(J:120\r\n) -----可以在设置中增加一向测试设置设置计数值，间隔时间等，长度小于等于8字节
测试数据：(测试数据以“,”或“,\r\n”分隔，以“.\r\n”结束)单位是ug/L保证取整，紧跟数据个数下面
在FLASH中默认创建CRP文件夹，每次测试结束后创建一个日期文件夹，如：20180101，在日期文件夹下以文件形式保存当前数据，文件名为[序号+编号+结果]，如：A000100000001U000000，序号开头字母可以是A,B,C代表不同的反应杯，后面是4位数字，编号为4位数字，结果开头字母为U代表后面的6位数字是uL为单位的整数值。文件名格式不对的文件为无效文件，删除？。
目录结构如下：
0:/CRP/20180119/A00010001U000000
0:/CRP/20180119/B00010002U000001
0:/CRP/20180119/C00010003U000002
2.质控文件格式
质控结果保存内容和格式：
质控品名：(A:cccccccc\r\n )-------手动输入，长度小于等于16字节？
类型：(B:低值\r\n )-------固定值（低值、中值、高值），长度小于等于16字节
批号：(C:nnnnnnnn\r\n )-------手动输入，长度小于等于16字节
有效期：(D: yymmdd\r\n )-------手动输入，长度小于等于8字节
靶值：(E:nnnnnn\r\n )-------手动输入，范围0~300，保留1位小数，标准仪器上测量得出的平均值
限值：(F:nnnnnn \r\n )-------手动输入，范围0~10，保留2位小数，标准仪器上测量得出的标准差SD值
测量结束时间：(G:yymmddhhmm\r\n) -自动生成，长度小于等于16字节
测量结果：(H: 标准差,平均值,变异系数\r\n) -----可以在设置中增加一向测试设置设置计数值，间隔时间等，长度小于等于32字节
31个（可以更多）质控品测量结果，包含：测量结束时间和测量结果重复向后添加
质控设置时，在FLASH中CRP文件夹下建立3个质控文件（对应低值、中值、高值0:/CRP/low；0:/CRP/mid；0:/CRP/high），根据质控输入创建文件，先存入质控品名，类型，批号，有效期，靶值，限值，测试结束时间和测试结果在每次测试完后在同名文件后追加（会循环出现G,H项）。
标准差与平均数的比值称为变异系数，记为C.V(Coefficient of Variance)。
质控结果的测量和样品测量是一样的。同一个质控品测2分钟得到120个OD值计算出一个标准差，平均值，变异系数
输入的靶值（原点），限值（标准差）用于做图，1个质控结果1个点，共31个点，纵坐标是质控结果标准差，横坐标是时间，靶值是纵坐标原点
质控品有高，中，低3瓶 各一套靶值，限值（标准差）
用户每隔一段时间（如每天）进行一次质控品的测试（一般包含低、中、高三个不同类型的质控品），如果其测量结果在质控范围（即靶值?限值的范围），可以认为仪器处于正常状态，如果超出范围，则可以作为需要进行分析处理甚至维护（清洗、校正）、维修的一个提示。
质控统计：即质控图，是质控品测量结果的直观图示
对应不同类型（低值、中值、高值）的质控品分别显示质控图
质控图的纵坐标
为测量结果，中间为靶值，上下分别有靶值＋限值、靶值－限值作为质量可控范围。如靶值为100，限值为10，那么图上显示中间的值为100，上下可控范围为110和90。
如果质控品供应商提供的是平均值（或靶值）以及标准差SD值，那么一般在纵坐标上出现7个标点（由低到高）：靶值－3SD，靶值－2SD，靶值－1SD，靶值，靶值＋1SD，靶值+2SD，靶值＋3SD
质控品的每个测量结果的显示：在可控范围内，根据靶值和限值按比例显示为一个“点”，如果出范围，则在上下范围外固定某个纵坐标显示一个“点”。
质控图的横坐标
一般为31个点，有以下2种处理方法：
1.	仅仅是每个质控品测量的结果点，最多记录31个测量结果，以后依次覆盖最先的结果。这样数据处理最为简单。缺点是无法与日期直观联系起来，因为有时一天连续测几次，在图示会“认为”做了几天。
2.	31个点严格对应日期的“日”，这样可以很直观的看到“每天”的质控情况。缺点是数据处理比较麻烦：同一天连续测几次质控样品，仅保留最后的结果（或者给用户一个保留结果的“确定键”），每月的1日必须清除上月结果，清除前是否提醒用户？

（R1：稀释液；R2：抗体液）

三、任务：任务之间要传递信息，所有任务一次创建完成，每个任务有一个状态机，有定时复位机制
Main：硬件初始化，创建主任务start_task，启动调度器
主任务：(start_task) 创建其它任务以及软件定时器，消息队列，信号量，事件标志组，任务通知等，创建完成删除自己。

HMI界面UART通讯：(hmi_task)负责界面显示。发送命令给HMI界面，接收HMI界面消息，接收其它任务的消息，数据读取和显示，条形码读取

串口通讯：(com_task)接收控制命令，返回信息。接收串口消息，发送消息给串口

阀控制、步进电机控制、泵控制：(valve_task，step_task，pump_task)接收阀控制信息（开关），接收步进电机控制信息（速度，位置），接收泵控制信息（速度，方向，时间）；返回各硬件状态

CRP检测流程：(crp_task) 开机自检：从HMI读取当前时间赋值给RTC，步进电机运动，光电信号测试，阀，泵控制


RBC检测流程：(rbc_task)，三个比色皿状态机分配


AD采样123：(adc_task)三个比色皿可以同时进行，数据有效/无效，具体数据，数据存储


清洗比色皿123：(wash_cuvette_task) 三个比色皿只能一个一个清洗


维护：(maintain_task)

四、函数：进入和返回时，状态需要保持不变
清洗池：


温控：抗体液2~8°控制，比色皿25℃控制。


洗针：


灌注：


排空：

五、测试任务：
串口测试：

HMI测试：

速度测试：步进电机，旋转泵，蠕动泵

精度测试：步进电机
哪些步进电机可以复用？

开关测试：74HC59可靠性测试，二通阀，三通阀开关、对电路的冲击、电流负载能力

AD测试：

温控测试：抗体液2~8℃；比色皿25℃

条形码测试：

恒流测试：RBC恒流驱动

六、界面：
A.开机欢迎，请确认废液管路畅通，反应杯正确安装，试剂已正确连接；确认；再次确认；系统复位；洗针；采样针出来；打缓冲液到杯中。（运动控制）
开机后如果走自检流程，先检测R1有否，如有拉空杯1，杯2，杯3,用R1通过注射器 2，电磁阀1用采样针打入杯1，杯2，杯3，到待测状态。如果没有R1，提示是否要继续,如不继续跳过流程到待测状态。如继续，上面流程走一遍也到待测状态。
B.测试，扫描条形码，读取1.试剂批号，2.检测项目，3.单位，4.剩余人份，5.样本类型，6.样本来源，7.正常值参考，8.ABCD；刷卡，读卡成功/失败，显示当前样本序号，编号，状态/结果（自动进样）；按测试键开始测试流程，实时显示状态，最终结果显示，实时显示三个反应杯的OD变化曲线。测试结束扣除一次剩余人份。发生故障（稀释液废液需要检测。哪些故障？剩余人份不减？）立即停止。（根据配置情况，分配反应杯子，运动控制，读卡，AD采样。试剂批号，剩余人份，AD采样值，保存FALSH）（状态/结果：试剂已用完，自动进样，采样OD值；实时状态：已满，正常；读卡：读卡成功，读卡失败）（创建CRP目录，按日期创建文件夹存放测试结果）
C.查询，按编号，按时间，按结果查询数据，打印数据（姓名，项目，样本编号，测量结果，测量时间，当前时间）。点击测试结果显示曲线。
D.
